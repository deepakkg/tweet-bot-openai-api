name: tweet-bot (artifact logs + compact state)

on:
  workflow_dispatch: {}
  schedule:
    # 09:15 IST == 03:45 UTC; 17:15 IST == 11:45 UTC
    - cron: '45 3 * * *'
    - cron: '45 11 * * *'

# Need write permission to push compact state back to repo
permissions:
  contents: write

jobs:
  tweet:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: tweet-bot
      cancel-in-progress: true

    env:
      # --- Secrets (set under Repository → Settings → Secrets) ---
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
      TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
      TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
      TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}

      # --- OpenAI / Model settings ---
      OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
      OPENAI_MAX_COMPLETION_TOKENS: ${{ vars.OPENAI_MAX_COMPLETION_TOKENS || '120' }}
      OPENAI_USE_MODERATION: ${{ vars.OPENAI_USE_MODERATION || 'true' }}

      # --- Core behavior ---
      DRY_RUN: ${{ vars.DRY_RUN || 'false' }}
      RUN_ONCE: "true"           # one-time run for GitHub Actions (prevents persistent scheduler)
      MAX_RETRIES: ${{ vars.MAX_RETRIES || '6' }}

      # --- Topics & schedule ---
      TWEET_TOPICS: ${{ vars.TWEET_TOPICS || 'productivity,leadership,learning,writing,craftsmanship,critical thinking,calm focus,habits' }}
      TWEET_TIMES_IST: ${{ vars.TWEET_TIMES_IST || '09:15,17:15' }}

      # --- Novelty & creativity controls ---
      CANDIDATE_COUNT: ${{ vars.CANDIDATE_COUNT || '6' }}
      SIMILARITY_THRESHOLD: ${{ vars.SIMILARITY_THRESHOLD || '0.78' }}
      EMBED_MODEL: ${{ vars.EMBED_MODEL || 'text-embedding-3-small' }}
      GEN_TEMPERATURE: ${{ vars.GEN_TEMPERATURE || '0.85' }}
      GEN_TOP_P: ${{ vars.GEN_TOP_P || '0.95' }}

      # --- Style rotation ---
      STYLE_WEIGHTS: ${{ vars.STYLE_WEIGHTS || 'observational:0.4,micro-story:0.2,contrarian:0.15,question:0.15,tip:0.1' }}

      # --- Style cooldown / anti-repetition ---
      STYLE_COOLDOWN_ENABLED: ${{ vars.STYLE_COOLDOWN_ENABLED || 'true' }}
      STYLE_COOLDOWN_WINDOW: ${{ vars.STYLE_COOLDOWN_WINDOW || '1' }}
      STYLE_PICK_RETRIES: ${{ vars.STYLE_PICK_RETRIES || '6' }}


      # --- Logging & misc ---
      TWEET_LOG_PATH: ${{ vars.TWEET_LOG_PATH || 'tweets_log.jsonl' }}
      TWEET_STATE_PATH: ${{ vars.TWEET_STATE_PATH || 'tweet_state.json' }}
      STATE_RECENT_LIMIT: ${{ vars.STATE_RECENT_LIMIT || '30' }}
      LOGLEVEL: ${{ vars.LOGLEVEL || 'INFO' }}
      TZ: "Asia/Kolkata"

    steps:
      - name: Checkout (fetch full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history to allow proper push / branch operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate required secrets
        run: |
          for v in OPENAI_API_KEY TWITTER_API_KEY TWITTER_API_SECRET TWITTER_ACCESS_TOKEN TWITTER_ACCESS_TOKEN_SECRET; do
            if [ -z "${!v}" ]; then
              echo "::error title=Missing secret::$v is not set"
              exit 1
            fi
          done

      - name: Optional jitter (schedule only)
        if: github.event_name == 'schedule'
        env:
          JITTER_MAX: 120
        run: |
          python - <<'PY'
          import os, random, time
          s = random.randint(0, int(os.getenv("JITTER_MAX","0")))
          print(f"Jittering {s}s...")
          time.sleep(s)
          PY

      - name: Run bot (single post)
        id: run_bot
        run: |
          python twitter_bot.py

      - name: Upload tweet log as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tweets-log-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ vars.TWEET_LOG_PATH || 'tweets_log.jsonl' }}
          if-no-files-found: ignore
          retention-days: 30

      # --- Persist only compact state back to the repository ---
      - name: Commit tweet state back to repo
        if: always()
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          STATE_FILE: ${{ vars.TWEET_STATE_PATH || 'tweet_state.json' }}
        run: |
          set -e
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"

          if [ ! -f "${STATE_FILE}" ]; then
            echo "State file not found, creating ${STATE_FILE}"
            printf '{\n  "recent_texts": [],\n  "recent_styles": [],\n  "updated_at": ""\n}\n' > "${STATE_FILE}"
          fi

          git add "${STATE_FILE}" || true
          if git diff --staged --quiet; then
            echo "No changes to ${STATE_FILE}; nothing to commit"
          else
            git commit -m "chore(tweets): update compact tweet state [skip ci]" || echo "Commit failed"
            git push origin HEAD:${{ github.ref_name }} || echo "Push failed; check branch protections or permissions"
          fi

      - name: Show commit status
        if: always()
        run: |
          echo "Workflow run: ${{ github.run_id }} complete. tweets_log.jsonl uploaded as artifact; compact state committed if changed."
